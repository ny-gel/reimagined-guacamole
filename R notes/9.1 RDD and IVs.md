## Forcing variable and cutpoint
The key feature of RDD is that there is a continuous variable Xi that determines who get treatment, denoted by Di (1 if treated).
- X is the **running/forcing variable**

## Sharp RDD
In sharp RDD, a unit is treated if Xi >= c, and not treated if Xi < c, where c is the **threshold** That is, Di is a deterministic function of Xi: Di = f(Xi). The **running variable** completely decides who gets treatment.

Several assumptions must be met:
- Treatment impacts outcome, but not any other variables
- Treatment assignment happens only at 1 cutpoint value of forcing variable
- Treatment assignment is independent of potential outcomes within a narrow interval of the forcing variable around the cutpoint.
- Counterfactual outcomes can be modeled within the interval around the forcing variable's cutpoint.

Plotting a scatter graph, with cutpoint at 600:
```r
# create scatter plot with watts as forcing variable and AQI as outcome
air_scatter <- ggplot(
  data = air_data,
  aes(x=watts, y=aqi, color = group, shape = group)) + 
  geom_point() +
  geom_vline(xintercept = 600, linetype = "dashed")
```

To add separate best-fit lines for each group above/below cutpoint:
```r
# add best-fit lines to air_scatter
air_scatter2 <- air_scatter +
 geom_smooth(
  aes(group=group), #plot separate lines for each group
  method = "lm" #use linear regression
)
```

### Choosing a bandwidth
In RDD, we need to look at points near the cutpoint to find treatment & control groups that are similar to each other.  
The **bandwidth** describes the distance on either side of the cutoff we should use to reduce(further subset) our dataset.
- Points >1 bandwidth above and below cutpoint should be discarded
- Wide bandwidth: Keeps more of original dataset, so we have more information to estimate effect. However, treatment groups might be too different on confounding variables, reducing accuracy.
- Narrow bandwidth: Retains less of original dataset, so treatment groups become more alike. However, smaller sample size = less info to estimate treatment effect.

To calculate the **IK bandwidth** for contribution matching dataset, where `cutpoint` = 600, forcing variable = `watts` and outcome variable = `aqi` with df `air_data`:
```r
library(rdd)

# calculate IK bandwidth
cont_ik_bw <- IKbandwidth(
  X = air_data$watts, # forcing variable
  Y = air_data$aqi, # outcome variable
  cutpoint = 600 # cutpoint value
)

# print the IK bandwidth to the console
air_ik_bw
[1] 11.32436
```

### Plotting the bandwidth
To illustrate the bandwidth visually, add the bandwidth lines to the scatterplot `air_scatter` using `geom_vline()` for reference lines:
```r
air_scatter +
  geom_vline(xintercept = 600 + c(-air_ik_bw, air_ik_bw)) # add lines to indicate the bandwidth
```

### Estimating the Causal Treatment Effect
The bandwidth impacts the type of causal estimand we can calculate in a RDD. Since the RDD uses a subset of the full dataset, we can **only estimate the local average treatment effect (LATE)** -> avg treatment effect among subset of data within bandwidth.
- To estimate the LATE, a regression model allowing for different slopes on each side of the cutpoint is fit,
  - 1. Regression model used to get pred value of outcome variable for each treatment group at the cutpoint,
  - 2. Difference between pred outcome values of treatment & control groups is estimate of LATE
  - 3. However, we may not be confident that this effect (LATE) will be the same in much smaller/larger data sets.

To fit the local linear regression model with `RDestimate()` function:
```r
# fit local linear regression model
air_rdd <- RDestimate(
  formula = aqi ~ watts,
  data = air_data,
  cutpoint = 600,
  bw = air_ik_bw
```

Results:
```r
RDestimate(formula = aqi ~ watts, data = air_data, cutpoint = 600, 
    bw = air_ik_bw)

Coefficients:
     LATE    Half-BW  Double-BW  
   -36.45     -32.82     -38.14
```


## Fuzzy RDD
In fuzzy RDD, we can think of D as a random variable given X, but E[Di|Xi = c] is known to be discontinuous at c. Note that E[Di|Xi =c]=Pr[Di =1|Xi =c]
- Other variables affect treatment assignment, some of them could be unobserved
- In other words, in fuzzy RDD, X at c is a predictor of who gets treatment, but it does not completely determine assignment


## Instrumental variable
In observational studies, when randomization is not possible, balance of measured and unmeasured confounding variables is not guaranteed. Without taking appropriate measures, the causal estimate of the effect of a treatment on an outcome will be biased.  


What is IV?
- Is a variable that is causally related to an outcome variable ONLY through another variable — typically the treatment variable of interest.
- <https://static-assets.codecademy.com/Courses/causal-inference/rdd-and-iv/iv-e2/index.html>


What is IV estimation?
- Is a causal inference method that uses instruments to help reduce bias from both measured AND unmeasured confounding variables.

### Assignment vs Compliance
`Always takers`: takes the treatment regardless of treatment assignment.  
`Never takers`: never takes the treatment regardless of treatment assignment.  
`Compliers`: takes the assigned treatment.  
`Defiers`: takes the opposite of the assigned treatment.

### Imperfect compliance and why ATE is not directly available
- When compliance is perfect, the treatment assignment and treatment received can be used interchangeably to get an accurate estimation of the **causal effect**.
- If treatment assignment ≠ actual treatment received (e.g., some assigned to treatment don't take it, and some in control sneak into treatment), then treatment assignment and receipt are **not interchangeable** → unable to estimate ATE directly.
- However, we can still measure the **ITT (intention to treat)** = Effect of being assigned to treatment (regardless of whether one complies).

### ITT vs CACE
-   **ITT**: compares average outcomes by *assignment*.
-   **CACE (Complier Average Causal Effect)**: compares average outcomes by *treatment received*, but only for those who **comply with assignment** (take treatment if assigned, don't take if not).
-   With **perfect compliance**, ITT = CACE = ATE.
-   With **imperfect compliance**, ITT underestimates the "true" effect of the treatment, since some assigned don't take it.

**Compliers' average causal effect (CACE)**
- is the IV estimation approximation of the ATT by estimating a local ATE (LATE), just among the compliers
- which requires four assumptions to be made
- 1. `Relevance`: the instrument has a causal effect on the treatment received.
- 2. `Exclusion`: the instrument affects the outcome ONLY indirectly through the treatment received.
- 3. `Exchangeability`: there are no confounders that influence both the instrument AND the outcome.
- 4. `Monotonicity`: there are no "defiers" in the sample.
<https://static-assets.codecademy.com/Courses/causal-inference/rdd-and-iv/iv-assumption/index.html>

### Ordinary Least Squares Regression
In the standard OLS regression model, the outcome is predicted directly from the treatment assignment & other confounding variables. This takes the form:  
**Outcome = β0 + β1 * Treatment Assignment**, where coefficient of β1 is the estimated **ATE** (diff betw. treatment and control).
- `Outcome` → dependent variable (response)
- `Treatment` → indep variable (treatment assignment, coded 0 for control and 1 for treatment)
- R automatically creates an intercept (β0)

For example, using data from `recycling` and `rebate` as a variable using OLS regression:
```r
lm(recycling ~ rebate, #outcome ~ treatment #dependent_var ~ indep_var1 + indep_var2
   data = recycle_df #dataset
)

# Output:

Call:
lm(formula = recycled ~ rebate, data = recycle_df)

Coefficients:
(Intercept)   rebate
  126.00       38.04
```
The OLS estimate suggests that participation in the `rebate` program leads to an average increase in `recycling` of 38.04 kilograms/person. However, this estimate is biased because OLS regression does not control bias introduced by unmeasured confounding variables or imperfect compliance.
- The unbiased estimate of the causal effect (β₁) only valid if (1) treatment assignment is random or (2) at least unconfounded (no omitted variables driving both treatment and outcome).

### Two-stages Least Squares Regression (2SLS)
In IV estimation, we must account for unmeasured confounding variables and imperfect compliance by 2SLS regression.
-   In the first stage, treatment received is predicted by the instrument (regress treatment on instrument):  
    **Predicted Treatment Received = α0 + α1 * Treatment Assignment**
    ```r
    first_stage <- lm(Treatment ~ Instrument, data = your_data)
    ```
-   In the second stage, the outcome is predicted as a function of the predicted treatment received from the first stage:  
    **Outcome = β0 + β1 * Predicted Treatment Received**, where β1 is used as the estimate of the CACE/local ATE.
  
To do so, we use the code:
```r
iv_mod <- ivreg(
  formula = outcome ~ treatment | instrument,
  data = df_name
)
```

To view the summary of coefficients and standard errors, we can use `summary(iv_mod)$coefficients`, which gives an example output using `recycling` data:
```r
             Estimate Std. Error   t value     Pr(>|t|)
(Intercept) 129.36463  0.8683141 148.98368 0.000000e+00
rebate       31.25452  1.4629239  21.36442 5.118885e-68
```
- The results show that the estimate of the effect of the `rebate` programe is 31.25, where participation in the program led to an average increase in `recycling` of 31.25kg/person. **This only applies to compliers**.
- In addition, it is **difficult to find a suitable instrument that has a strong r/s with treatment**. If the instrument is only weakly related, the 2SLS regression will produce inaccurate estimates of CACE → as seen by the **large standard errors**
- The `ivreg()` function is preferred to `lm()` or `glm()` functions since it automatically corrects standard errors to account for the fact that 2SLSR models uses **predicted values of treatment.**

### Task 1
An online retailer is interested in studying the effect of offering video streaming services on the average amount of money that users spend on the platform. The retailer gives its paying members access to exclusive video content at no additional expense. The online retailer then starts an email campaign for a random subset of users to encourage them to use the streaming services.  
The retailer tracks the amount of money spent by its users in a year and compiles the following variables into a dataframe named `video_df`:
- `email`: whether or not an individual received the email campaign (received email vs. did not receive email).
- `streaming`: whether or not an individual used the streaming services (used service vs. did not use service).
- `spending`: the amount of money spent by an individual in a year (dollars)
  
There are many factors that could influence whether or not an individual on the platform uses the video streaming services. For example, some individuals might have more free time to watch videos. Other individuals might not be interested in the content on the platform. The online retailer has no way to capture this information.

Receiving the email does not directly impact how much someone spends — it only impacts the likelihood of using the streaming platform. Thus, the instrument is whether or not the individual was emailed.

