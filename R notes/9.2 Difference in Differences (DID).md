## Introduction to DID
Imagine that a California state law was passed in 2016 that raised the minimum wage beginning in the year 2017. We are interested in what this law’s impact has been on student wages since student jobs often pay low wages.
We note that wages rise and fall from year to year, but we see a particularly large rise from 2016 to 2017.
It’s easy to assume the large increase was entirely due to the new minimum wage law. But what would average student wages in 2017 have looked like had the law NOT been passed?
- Would wages still have increased a lot, meaning the law had little impact?
- Would wages have decreased, meaning the law had an even larger impact than just the difference between 2016 and 2017 wages?
The fundamental principle of causal inference tells us that we can’t observe both situations, so we need to use other observed data as a substitute for what student wages in California would have looked like in 2017 had the law not passed.

DID is a causal inference technique that estimates a treatment effect by analysing treatment & control trends over time.

## Task 1 - Plotting
Let’s say we have some data on student wages at the state level in a dataset called `wages`. It has the following variables:
- `state` where the college is located
- `year` the year the data is collected
- `avg_wage` average student wage across all state public colleges  
Since we only want to plot California schools, filter by the `state` variable and then add code for our plot:

```r
ca_wages <- wages %>% # plot wages versus years
  filter(state == "California") %>%  #only California schools
  ggplot(aes(x = year, y = avg_wage)) + #wages over time
  geom_line() #line plot
```
Then, add a dashed line to see the change more clearly:
```r
ca_wages +
  geom_vline(xintercept = 2016, linetype = "dashed") +
  scale_x_continuous(breaks = c(2007:2017))
```

## Task 2 - Parallel Trends Assumption
We can use the other state’s data to approximate the counterfactual. Hence with DID, we use the trend of a control group to estimate the counterfactual trend for the treated, or simply put, to estimate the **average treatment effect on the treated (ATT).**
- A good control group requires the **parallel trends assumption** to be met: trends between the control and treatment groups should be similar prior to the start of treatment.
  -  Specific values between both groups do not need to be the same, but they should have the **same change over time**.
  -  This may be a disadvantage of DID, since we need pre-treatment data for BOTH groups + they must show similar trends pre-treatment.
- In addition, another assumption is that the treatment group was selected for the treatment by a **factor that is independent of the outcome.**
- Lastly, it also includes the assumptions for all causal inference methods: **Exchangability, SUTVA, Overlap.**

Using the example of `Washington`, which did not impose a new minimum wage law, we can view these two groups in a single plot:
```r
# plot wages versus years by state for CA and WA
ggplot(data = wages, aes(x = year, y = avg_wage, color = state, linetype = state)) +
  geom_line() + 
  geom_vline(xintercept = 2016, linetype = "dashed") + #vertical line at 2016
  scale_x_continuous(breaks = c(2007:2017)) #x-axis scale 2007 to 2017
```

### Task 3 - 2x2 method
To keep things simple, we will analyse our `student_wage` data only the year BEFORE and AFTER the law was passed (2016 and 2017). This requires a `filter()` function.


For the `ERAS` dataset:
```r
#create filtered dataset with specified observations
filtered <- eras %>%
filter(year %in% c(2014, 2015)) %>%
select(year, hospital, los)
```
Or
```r
df2 <- df %>% filter(year == 1992 | year == 1993)
```

For the `wages` dataset:
```r
filtered <- wages %>%
filter(year %in% c(2016, 2017)) %>%
select(wage, year, state)
```

From [this plot](https://static-assets.codecademy.com/Courses/causal-inference/did/did-e5-narr1.png), we see that the `Washington` schools had a much smaller increase in wages than `California`, so we assume that if the law was NOT passed, the rise in wages would be the same.
- Therefore, with the new dashed line drawn, the **estimated ATT** = difference between the observed 2017 `California` wages and the 2017 `Washington` (counterfactual) wages.

## Calculating ATT with means
1. What we can do is to measure the average (mean) wages for `California` and `Washington` in 2016 and 2017.
2. Then, we find the difference in mean wages in 2017 (year after law passed) and 2016 (year before law passed) for each `state` to identify the change resulting from the law.
3. Hypothetically, if the law had no effect on wages, we would expect the difference between the post-treatment mean and the pre-treatment mean for the treatment group (`CA`) would be similar to the difference for the control group (`WA`).
4. i.e. CAmean2017-CAmean2016 = WAmean2017-WAmean2016
5. But to identify how much of the change in the treatment group were due to factors other than the new law, we again **take the difference of the difference (in means) we just found**.  

Using `tickets2` dataframe:
```r
print(tickets2) # print tickets2 post year-filter
```
Which returns:
```r
     city year    sales
1  Sydney 2018 515.1175
2  Sydney 2019 514.1180
3 Toronto 2018 494.9121
4 Toronto 2019 496.1579
```
Find the difference between `Sydney` and `Toronto` between 2019 and 2018 respectively:
```r
Tdiff <- tickets2$sales[4] - tickets2$sales[3]
Sdiff <- tickets2$sales[2] - tickets2$sales[1]
```

Find the DID estimate for the impact of the new tax by subtracting `Tdiff` from `Sdiff`:
```r
did_means <- Sdiff - Tdiff
```

## Calculating ATT using Linear Regression
1. We can transform the `state` or `city` treatment variable to `treat`, alongside a treatment indicator (1 for treated, 0 for control).
2. Then, we transform `year` with a time indicator (1 for post-change, 0 for pre-change).
```r
wages2$treat <- ifelse(wages2$state=="California",1,0) # transform state to treat
wages2$time <- ifelse(wages2$year==2017,1,0) # transform year to time

tickets2$treat <-
ifelse(tickets2$city =="Sydney",1,0) # add treatment indicator
tickets2$time <-
ifelse(tickets2$year =="2019",1,0) # add time indicator
```
For the DID regression model, we run an `lm()` function for the interaction between `outcome_var` with `treat*year`.
```r
did_reg <- lm(
  formula = sales ~ treat*time, # outcome ~ treat*time
  data = tickets2 #use subsetted data
)

#print data
Coefficients:
(Intercept)        treat         time   treat:time  
    494.912       20.205        1.246       -2.245  
```

- `Intercept` indicates the expected value for pre-treatment average student wages for the control group (Washington 2016).
- `treat` is the difference between the control group and the treatment group at the pre-treatment time (California 2016 - Washington 2016).
- `time` is the difference between the pre-treatment and post-treatment times for the control group (Washington 2017 - Washington 2016).

Combining these coefficients, we can get:
```r
Mean	     Equivalent Coefficient(s)
Washington 2016	      Intercept
California 2016	      Intercept + treat
Washington 2017	      Intercept + time
California 2017	      Intercept + treat + time + treat:time
```
